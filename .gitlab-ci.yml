## GitLab CI for Time Attendance monorepo
## Flow: GitLab (self-host) -> GitLab Runner (Kubernetes executor) -> Kaniko build -> Harbor -> ArgoCD GitOps -> Kubernetes
##
## Required GitLab CI variables (Settings > CI/CD > Variables):
## - HARBOR_URL        : e.g. harbor.bitcare.local (or http://192.168.1.xxx if DNS not working)
## - HARBOR_PROJECT    : e.g. bitcare-attendance
## - HARBOR_USER       : Harbor robot/user with push permission
## - HARBOR_PASSWORD   : Password/token for the above user
## - HARBOR_IP         : (Optional but recommended) IP address of Harbor for DNS fix, e.g. 192.168.1.240
##
## Notes:
## - CI only builds & pushes images and updates manifests under k8s/.
## - No kubectl / SSH is used; ArgoCD watches this repo/path and syncs to the cluster.
## - Uses CI_JOB_TOKEN for pushing manifests (simpler than PAT).

stages:
  - build
  - deploy

.kaniko-template:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - 'echo "Preparing Kaniko configuration..."'
    - mkdir -p /kaniko/.docker
    # Extract Harbor hostname (remove http:// or https:// if present)
    - |
      HARBOR_HOST=$(echo "${HARBOR_URL}" | sed 's|^https\?://||' | sed 's|/.*||')
      echo "HARBOR_HOST=${HARBOR_HOST}"
    - |
      HARBOR_HOST=$(echo "${HARBOR_URL}" | sed 's|^https\?://||' | sed 's|/.*||')
      cat <<EOF > /kaniko/.docker/config.json
      {"auths":{"${HARBOR_HOST}":{"username":"${HARBOR_USER}","password":"${HARBOR_PASSWORD}"}}}
      EOF
    # Force DNS resolution for Harbor inside the Kaniko container (if HARBOR_IP is set)
    - |
      if [ -n "${HARBOR_IP}" ]; then
        HARBOR_HOST=$(echo "${HARBOR_URL}" | sed 's|^https\?://||' | sed 's|/.*||')
        echo "${HARBOR_IP} ${HARBOR_HOST}" >> /etc/hosts
        echo "Added Harbor IP to /etc/hosts: ${HARBOR_IP} -> ${HARBOR_HOST}"
      fi
    - 'echo "HARBOR_URL=${HARBOR_URL}"'
    - 'echo "HARBOR_USER=${HARBOR_USER}"'
    - 'echo "HARBOR_PROJECT=${HARBOR_PROJECT}"'
    - 'cat /kaniko/.docker/config.json | sed "s/${HARBOR_PASSWORD}/***MASKED***/g"'
    # Test Harbor connection
    - |
      HARBOR_HOST=$(echo "${HARBOR_URL}" | sed 's|^https\?://||' | sed 's|/.*||')
      echo "Testing Harbor connection to ${HARBOR_HOST}..."
      curl -k -u "${HARBOR_USER}:${HARBOR_PASSWORD}" "https://${HARBOR_HOST}/api/v2.0/projects/${HARBOR_PROJECT}" || echo "Warning: Could not verify project access"

build-api:
  stage: build
  extends: .kaniko-template
  tags:
    - atd
  script:
    - 'echo "Building backend Docker image with Kaniko..."'
    - |
      HARBOR_HOST=$(echo "${HARBOR_URL}" | sed 's|^https\?://||' | sed 's|/.*||')
      /kaniko/executor \
      --context "${CI_PROJECT_DIR}/api" \
      --dockerfile "${CI_PROJECT_DIR}/api/Dockerfile" \
      --destination "${HARBOR_HOST}/${HARBOR_PROJECT}/api:${CI_COMMIT_SHORT_SHA}" \
      --destination "${HARBOR_HOST}/${HARBOR_PROJECT}/api:latest" \
      --insecure-pull \
      --skip-tls-verify \
      --cache=true \
      --cache-ttl=168h
    - 'echo "Backend image pushed successfully: ${HARBOR_URL}/${HARBOR_PROJECT}/api:${CI_COMMIT_SHORT_SHA}"'

build-web:
  stage: build
  extends: .kaniko-template
  tags:
    - atd
  script:
    - 'echo "Building frontend Docker image with Kaniko..."'
    - |
      HARBOR_HOST=$(echo "${HARBOR_URL}" | sed 's|^https\?://||' | sed 's|/.*||')
      /kaniko/executor \
      --context "${CI_PROJECT_DIR}/web" \
      --dockerfile "${CI_PROJECT_DIR}/web/Dockerfile" \
      --destination "${HARBOR_HOST}/${HARBOR_PROJECT}/web:${CI_COMMIT_SHORT_SHA}" \
      --destination "${HARBOR_HOST}/${HARBOR_PROJECT}/web:latest" \
      --insecure-pull \
      --skip-tls-verify \
      --cache=true \
      --cache-ttl=168h
    - 'echo "Frontend image pushed successfully: ${HARBOR_URL}/${HARBOR_PROJECT}/web:${CI_COMMIT_SHORT_SHA}"'

update-manifest:
  stage: deploy
  image: alpine/git:latest
  tags:
    - atd
  dependencies:
    - build-api
    - build-web
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  before_script:
    - apk add --no-cache git sed
    - git config --global user.email "gitlab-ci@bitcare.local"
    - git config --global user.name "GitLab CI"
  script:
    - 'echo "Updating k8s manifests with image tags: ${CI_COMMIT_SHORT_SHA}"'
    - |
      # Update backend image
      IMAGE_API="${HARBOR_URL}/${HARBOR_PROJECT}/api:${CI_COMMIT_SHORT_SHA}"
      sed -i "s|image:.*${HARBOR_PROJECT}/api:.*|image: ${IMAGE_API}|g" k8s/backend/deployment.yaml
    - |
      # Update frontend image
      IMAGE_WEB="${HARBOR_URL}/${HARBOR_PROJECT}/web:${CI_COMMIT_SHORT_SHA}"
      sed -i "s|image:.*${HARBOR_PROJECT}/web:.*|image: ${IMAGE_WEB}|g" k8s/frontend/deployment.yaml
    - git add k8s/backend/deployment.yaml k8s/frontend/deployment.yaml
    - |
      git commit -m "chore: update images to ${CI_COMMIT_SHORT_SHA}" || exit 0
    - |
      git push "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${CI_COMMIT_BRANCH}" || exit 0
    - 'echo "Manifest updated and committed successfully"'
    - 'echo "ArgoCD will automatically sync the new image tags"'

